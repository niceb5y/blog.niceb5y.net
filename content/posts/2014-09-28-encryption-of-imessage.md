---
categories: apple
date: 2014-09-28T12:00:00+09:00
title: iMessage의 암호화 방법
url: /encryption-of-imessage/
---

<img src="/images/V1Swv4udx.png" alt="niceb5y blog">

&nbsp;

요즘 카카오톡 감시로 말이 워낙 많아서... <a href="http://telegram.org" target="_blank">텔레그램</a>과 같은 암호화가 가능한 + 서버가 외국에 있는 메신저를 쓰는 분들이 많아지는 것 같습니다.

그런데 텔레그램도 뭔가 말이 많아서(...) 쓸까 말까 고민을 하던 와중에 그냥 어렴풋이 좋다고 알던 애플의 아이메시지(iMessage) 알고리즘이 문득 궁금해져서 찾아보게 되었습니다.

애플의 <a href="http://images.apple.com/iphone/business/docs/iOS_Security_Feb14.pdf" target="_blank">보안 관련 문서</a>에 설명되어 있고, 한마디로 요약하면 <a href="http://ko.wikipedia.org/wiki/공개_키_암호_방식" target="_blank">공개키 암호</a>화를 이용합니다.

# iMessage의 암호화 방법

<img src="/images/EJNzdEdOx.jpg" alt="niceb5y blog">

1 - 기기가 아이메시지 대화를 시작하는 순간, 아이메시지는 두 종류의 공개키 + 개인키를 생성합니다.

1280bit [RSA](http://ko.wikipedia.org/wiki/RSA_암호) (암호화) + 256bit [ECDSA](http://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm) (전자서명)

2 - 개인키들은 기기의 키체인에, 공개키들은 APNs(애플 푸시 네트워크 서버) 토큰등과 함께 애플의 디렉토리 서비스(IDS) 서버에 저장이 됩니다.

3 - 사람 A가 사람 B의 기기로 메시지를 보내기 위해 B의 연락처를 입력하면, A의 기기가 애플의 서버에 접속해서 B의 공개키와 APNs 토큰등을 가져옵니다.

4 - 메시지의 내용은 보내는 사람의 개인키로 전자서명됩니다.

5 - 메시지가 전송될때 타임스탬프와 APNs 라우팅 정보등은 따로 암호화는 하지 않지만, APNs와는 TLS 암호화를 이용하여 통신합니다.

6 - 만약 한 사람이 기기가 2대 이상이 있다면, 기기들사이에서는 개인키를 어떻게 공유할까요? 공유하지 않습니다. 기기별로 각각 다른 공개/개인키를 가지고 있고, 메시지를 보낼 때에는 각각의 기기에 맞게 암호화해서 따로 저장합니다.

7 - 메시지가 너무 길거나 첨부파일이 포함되어 있으면 iCloud에 업로드되며 랜덤 생성된 키로 암호화 됩니다. 이 키와 URI또한 서명 / 암호화를 거칩니다.

<img src="/images/EyLmOVOOl.png" alt="niceb5y blog">

8 - 모든 메시지는 기기에 도착하자마자 APNs에서 삭제되며, 기기가 꺼져있다던가 등등의 이유로 기기에 전송이 되지 않으면 7일간 더 보관됩니다.

&nbsp;

음... 어쨌든 상당히 괜찮은 방식인 것 같네요. 이것도 완벽하지는 않다고 하지만요. (뭐 사실 완벽한게 어디 있겠습니까만...)

문제는 '애플이 가로챌 수 있다.'...같은 것들이 문제라는 건데 일단 몇개 뽑아 보면,

1 - (정부든 애플이든)메시지를 가로채서 다른사람인척 하고 대화를 할 수 있다.

2 - 양자 컴퓨팅이나 새로운 알고리즘으로 인해 RSA + ECC등이 무효화 되었다.

3 - 개인키를 찍어맞혔다(...). 또는 어쩌다 개인키를 스스로 유출시켰다(?).

...정도가 문제가 될 것 같은데...

애플이 그랬다가 전화기 장사 망할 것이고(...).

어쨌든 1280bit RSA암호화니 복호화는 쉽지 않다고 보는게 맞겠군요.

상시감시 그런건 불가능하다고 보는게...

&nbsp;

사실 일반 사람들 수준에선 과분한 수준이고...

보안이 더 중요하면 전용 메신저를 만드시는걸 추천드립니다(...).

&nbsp;

(*)졸린데 끄적거린게 많아서 틀린게 많을 수 있습니다. 뭐 사실 RSA알고리즘 같은것도 책에서 대충 봐서(...) 원문을 읽으세요(...)
